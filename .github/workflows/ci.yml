name: Continuous Integration
on:
    push:
        branches:
          - main
    pull_request:
        types: 
          - opened
          - reopened
          - synchronize
          - ready_for_review
        branches:
          - main

permissions:
    contents: read
    pages: write
    id-token: write

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        env:
          XDG_CACHE_HOME: /home/runner/.cache
        steps:
          - name: Checkout
            uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        
          - name: Pull and Update EIPs Submodule
            run: git submodule update --init --recursive

          - name: Use Node.js
            uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
            with:
                node-version: 22.x

          - name: Cache node_modules
            id: cache-npm-packages
            uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
            env:
              cache-name: cache-node_modules
            with:
              path: node_modules
              key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('package-lock.json') }}

          - name: Install Dependencies
            if: ${{ steps.cache-npm-packages.outputs.cache-hit != 'true' }}
            run: npm ci

          - name: Cache cache directory
            id: cache-xdg-cache
            uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
            env:
              cache-name: cache-xdg-cache
            with:
              path: ${{ env.XDG_CACHE_HOME }}
              key: xdg-cache-${{ env.cache-name }}-v1

          - name: Build
            run: npm run build

          - name: Setup Pages
            if: github.ref == 'refs/heads/main' && github.event_name == 'push'
            uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

          - name: Upload artifact
            uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
            with:
                path: '.vitepress/dist'

          - name: Deploy to GitHub Pages
            id: deployment
            if: github.ref == 'refs/heads/main' && github.event_name == 'push'
            uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
